<?php

function abast_menu() {
	
	$items['admin/settings/abast'] = array(
		'title' => 'Abast',
		'description' => utf8_encode('ConfiguraciÃ³ de la BD de l\'Abast'),
		'page callback' => 'drupal_get_form', /* Funcion a llamar*/
		'page arguments' => array('abast_conf_form'), /*array de argumentos (En este caso el resultado de una funcion*/
		'access arguments' => array('administer abast settings'), 
		'type' => MENU_NORMAL_ITEM,
		'file' => 'abast.admin.inc', /* fichero donde esta la función*/
	);
	$items['abast'] = array(
		'title' => t('SubscripciÃ³ a l\'Abast'),
		'page callback' => 'abast_register', /* Funcion a llamar*/
		'access arguments' => array('access content'),
		'type' => MENU_CALLBACK,
	);

	
	
	return $items;
}


function abast_register()
{
	$form = drupal_get_form('abast_register_form');
	return theme('abast_register_form_theme', $form);
}


function abast_register_form()
{
	$form['abast_mail'] = array
	(
		'#type' => 'textfield',
		'#title' => t('Email de registre'),
		'#description' => t("Introdueix aquÃ­ el email que vols registrar"),
		'#required' => TRUE,
	);
	$form['abast_submit']=array(
		'#type'=>'submit',
		'#value' =>t('Subscriu-me')
	);
	return $form;
}

function abast_register_form_validate($form, &$form_state) {
  if (!abast_check_email($form_state['values']['abast_mail'])) {
		form_set_error('abast_mail', t(('S\'ha d\'indroduir un email vÃ lid')));
  }
  else
  {
		$link = abast_db_connect();
		$table = variable_get('abast_server_table', '');
		$email = htmlspecialchars((mysql_real_escape_string($form_state['values']['abast_mail'])));
		$query="SELECT * FROM pommo_subscribers where email = '$email'";
		$result = mysql_query($query, $link);
		if(mysql_num_rows($result)>0)
		{
			form_set_error('abast_mail', t('Aquest email ja estÃ  subscrit'));
		}
		mysql_free_result($result); 
		mysql_close($link);
	
  }
  
}
function abast_check_email($email) { 
    	if (valid_email_address(trim($email))) {
    		return true;
    	}
    	return false;
    }

function abast_register_form_submit($form, &$form_state) {
	
	$link = abast_db_connect();
	$email = htmlspecialchars((mysql_real_escape_string($form_state['values']['abast_mail'])));
	$query = "INSERT INTO ";
	$IP = $_SERVER['REMOTE_ADDR'];
	$time = date("Y-m-d H:i:s");
	
	$link = abast_db_connect();
	$query="INSERT INTO pommo_subscribers (`email`, `time_registered`, `flag`, `ip`, `status`) VALUES ('$email','$time',0,INET_ATON('$IP'),1)" ;
	
	
	mysql_query($query, $link);
	mysql_close($link);
	
	drupal_set_message("El registre ha estat completat amb Ã¨xit");
	
}
	
	
function abast_perm(){
  return array('administer abast settings') ;
}



function abast_theme() {
  return array(
    'abast_register_form_theme' => array(
      'template' => 'abast-register-form',
      'arguments' => array(
		'form' => null, 
      ),
    ),);
}


	
/*
	Function to get a link to a external DB connection
	Remember to close the link when you complete your work
*/
function abast_db_connect() 
{ 
   if (!($link=mysql_connect(variable_get('abast_server',''),variable_get('abast_server_user',''),variable_get('abast_server_password',''))))
   { 
      drupal_set_message("Servei no disponible temporalment.","error");
      return null;
	  
   } 
   if (!mysql_select_db(variable_get('abast_server_db',''),$link)) 
   { 
      drupal_set_message("Servei no disponible temporalment.","error");
      return null;
	  
   } 
 
   return $link; 
}
