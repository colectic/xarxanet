<?php
// $Id$ 

function equiblocks_init() {
    $basepath = drupal_get_path('module', 'equiblocks');

    drupal_add_js($basepath . '/js/user.js');
    drupal_add_css($basepath . '/css/user.css');
}

/**
 * Implementation of hook_block() 
 */
function equiblocks_block($op='list', $delta=0, $edit=array()) {
    switch ($op) {
        case 'list':
            $blocks = array();
            $blocks['blocks']['info'] = t('Equilibri Blocks');
            return $blocks;
        case 'view':
            global $user;
            if($user->uid) {
                $usercontent = equiblocks_logged_user_content($user->uid, $user->name);
            } else {
                $usercontent = equiblocks_unlogged_user_content();
            }

            if(module_exists('date_api')) {
                $time = date_format_date(date_now(), 'custom', 'g:ia F j');
                $tz = str_replace('_', ' ', date_default_timezone_name());
            } else {
                $time = format_date(time(), 'custom', 'g:ia F j');
                $offset = variable_get('date_default_timezone', 0);
                $hours = floor(abs($offset / 3600));
                $minutes = str_pad(abs($offset % 3600) / 60, 2, 0, STR_PAD_LEFT);
                $tz = $offset >= 0 ? "+{$hours}:{$minutes} GMT" : "-{$hours}:{$minutes} GMT";
            }

            return array('content' => '<div id="equiblock">' . $usercontent . '</div>');
    }
}

function equiblocks_logged_user_content($uid, $username) {
    global $user;

    return '
    <div class="equiblock-element">
        <ul id="equiblock-user-options">
            <li><a href="' . url('user/'.$uid.'/edit') . '">' . t('Account settings') . '</a></li>
            <li><a href="' . url('logout') . '">' . t('Log out') . '</a></li>
        </ul>
    </div>';
}

function equiblocks_unlogged_user_content() {
    return '
    <div class="equiblock-element">
        <div id="equiblock-login-form" class="equiblock-content">'.  drupal_get_form('user_login_block').'</div>
    </div>';
}