<?php

/**
 * Implements hook_menu().
 */
function my_migrations_menu() {
	$items['admin/api/export/taxonomy'] = array(
		'title' => 'Taxonomy export',
		'page callback' => 'my_migrations_taxonomy',
		'access callback' => TRUE,
	);

	return $items;
}

/**
 * Retrieves all the taxonomy terms.
 */
function my_migrations_taxonomy() {
  $data = [];
	$query = db_select('taxonomy_term_data', 't');
	$query->leftJoin('taxonomy_term_hierarchy', 'h', 'h.tid = t.tid');
	$query->leftJoin('taxonomy_vocabulary', 'v', 'v.vid = t.vid');
	$query->addField('t', 'tid', 'tid');
	$query->addField('t', 'name', 'tname');
	$query->addField('t', 'vid', 'vid');
	$query->addField('v', 'name', 'vname');
	$query->addField('h', 'parent', 'parent');
	$query->orderBy('t.tid', 'ASC');
  // Filter by vocabuloary ID
  if (isset($_GET['vid'])) {
    $vid = $_GET['vid'];
    $query->condition('t.vid', $vid);
  }
  // Filter by a range of values
  if (isset($_GET['from']) && isset($_GET['to'])) {
    $from = $_GET['from'];
    $to = $_GET['to'];
    $query->range($from, $to);
  }
	$results = $query->execute();
  // Build an array with the retrieved data
  foreach ($results as $item) {
    array_push($data, $item);
  }
  // Return data in JSON format
  drupal_json_output($data);
}
